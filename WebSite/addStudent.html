<!doctype html>
<html lang="zh-CN">
<head>
    <base target="right" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" type="text/css" href="css/easyui.css" />
    <script type="text/javascript" src="Scripts/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="Scripts/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="Scripts/login.js"></script>
    <script type="text/javascript" src="Scripts/typecheck.js"></script>
    <title>学生录入</title>
    <style>
        .contain
        {
            width: 960px;
            margin-left: 15px;
            margin-right: 15px;
        }
        .logtable
        {
            width: 960px;
            margin: 0px auto;
        }
        .msgtb
        {
            width: 960px;
            margin-top: 20px;
            border-left: 1px solid #d3dbde;
        }
        .msgtb td
        {
            border-left: none;
            border-right: none;
            padding-right: 25px;
        }
        .tdtxt
        {
            background-color: #f6f6f6;
        }
        .ttl
        {
            text-align: left;
        }
        .spttl
        {
            font-size: 20px;
            margin-left: 10px;
        }
        .tdcontent
        {
            background-color: #fbfbfb;
            text-align: left;
            height: 30px;
        }
        .input_long
        {
            width: 100%;
        }
        .select2
        {
            height: 100%;
            width: 100%;
        }
        #addsignup
        {
            display: none;
        }
        .combo
        {
            border: none;
        }
        #addtb td
        {
            height: 40px;
        }
        .input-text
        {
            padding: 0px 5px 0px 5px;
        }
        .select_border2
        {
            padding: 0 0 0 0;
            height: 30px;
            display: inline-block;
            background: #fff;
        }
        .input-text2
        {
            padding: 0px 5px 0px 5px;
        }
    </style>
</head>
<body>
    <div class="contain">
        <div class="logtable">
            <h1>
                跃飞教育-学生录入</h1>
            <table class="list_table msgtb" cellpadding="0" cellspacing="0">
                <tr>
                    <td class="tdtxt ttl" colspan="4">
                        <span class="spttl">学生信息</span>
                    </td>
                </tr>
                <tr>
                    <td class="tdtxt">
                        学生姓名：
                    </td>
                    <td class="tdcontent">
                        <input id="txtstuname" type="text" class="input-text lh30" />
                    </td>
                    <td class="tdtxt">
                        学生ID：
                    </td>
                    <td class="tdcontent">
                        <label id="labStuid"></label>
                    </td>
                </tr>
                <tr>
                    <td class="tdtxt">
                        年龄：
                    </td>
                    <td class="tdcontent">
                        <input id="txtage" class="input-text lh30" type="text" />
                    </td>
                    <td class="tdtxt">
                        姓别：
                    </td>
                    <td class="tdcontent">
                        <div class="select_containers ">
                            <select id="slsex" class="select" name="slsex">
                                <option selected="selected" value="男">男</option>
                                <option value="女">女</option>
                            </select>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="tdtxt">
                        在读学校：
                    </td>
                    <td class="tdcontent">
                       <div class="select_border">
                                        <div class="select_containers ">
                                            <input id="cbtsc" style="width: 200px;" />
                                        </div>
                                    </div>
                    </td>
                    <td class="tdtxt">
                        年级：
                    </td>
                    <td class="tdcontent">
                        <div class="select_containers ">
                           <input id="cbtsg" style="width: 200px;" />
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="tdtxt ttl" colspan="4">
                        <span class="spttl">家长信息：</span>
                    </td>
                </tr>
                <tr>
                    <td class="tdtxt">
                        家长姓名：
                    </td>
                    <td class="tdcontent">
                        <input id="txtparent_name" class="input-text lh30" type="text" />
                    </td>
                    <td class="tdtxt">
                        联系电话：
                    </td>
                    <td class="tdcontent">
                        <input id="txtparent_phone" class="input-text lh30" type="text" />
                    </td>
                </tr>
                <tr>
                    <td class="tdtxt">
                        电子邮箱：
                    </td>
                    <td class="tdcontent" colspan="2">
                        <input id="txtemail" class="input-text lh30" type="text" size="30" />
                    </td>
                    <td class="tdcontent">
                    </td>
                </tr>
                <tr>
                    <td class="tdtxt">
                        工作单位：
                    </td>
                    <td class="tdcontent" colspan="3">
                        <input id="txtparent_dep" class="input-text lh30 input_long" type="text" />
                    </td>
                </tr>
                <tr>
                    <td class="tdtxt">
                        家庭住址：
                    </td>
                    <td class="tdcontent" colspan="3">
                        <input id="txtparent_address" class="input-text lh30 input_long" type="text" />
                    </td>
                </tr>
            </table>
                     <div id="divbtn" class="mt10">
                <input type="button" value="确定" onclick="addStu();" class="ext_btn ext_btn_submit" />
                <input type="button" onclick="clearall();" class="ext_btn ext_btn_success" value="重填" />
                <input type="button" value="返回" onclick="location.href='javascript:history.go(-1)'"
                    class="ext_btn" />
            </div>
             <div id="divexit" style="display:none;" class="mt10">
                <input type="button" value="修改" onclick="EditStu();" class="ext_btn ext_btn_submit" />
                <input type="button" value="返回" onclick="location.href='javascript:history.go(-1)'"
                    class="ext_btn" />
            </div>
            <a href="javascript:courseSlide();" id="acourse" class="ext_btn" style="float: left; margin-top: 15px;">
                <span class="add"></span>添加报名信息</a>
            <br />
            <br />
            <div id="addsignup" class="box">
                <div class="mt10">
                    <div class="box span10 oh">
                        <div class="box_bottom pb5 pt5 pr10" style="border: 1px solid #dadada;">
                            <div class="search_bar_btn">
                                &nbsp;&nbsp; 科目筛选：<span>
                                    <div class="select_border">
                                        <div class="select_containers ">
                                            <input id="cbt" style="width: 200px;" />
                                        </div>
                                    </div>
                                </span>&nbsp;&nbsp;选择老师： <span>
                                    <div class="select_border">
                                        <div class="select_containers ">
                                            <input id="cbtTe" style="width: 200px;" />
                                        </div>
                                    </div>
                                </span>
                                &nbsp;&nbsp; 课程状态：<span>
                                    <div class="select_border2">
                                        <div class="select_containers ">
                                            <select name="" id="sestatus" class="select">
                                                <option value="0">全部</option>
                                                <option value="1">已结束</option>
                                                <option value="2">进行中</option>
                                                <option value="3">未开始</option>
                                            </select>
                                        </div>
                                    </div>
                                </span>
                            </div>
                        </div>
                        <br />
                        <table id="dg" title="课程列表显示" />
                    </div>
                    <div class="box_bottom pb5 pt5 pr10" style="border: 1px solid #dadada;">
                        <div class="search_bar_btn">
                            &nbsp;&nbsp; 交费：&nbsp;<input type="text" id="txtpay" name="name" class="input-text lh30"
                                size="10" />&nbsp;元
                        </div>
                    </div>
                </div>
            </div>
           
        </div>

        <div class="box_bottom pb5 pt5 pr10">
            <div class="search_bar_btn">
                &nbsp;&nbsp;<br />
            </div>
        </div>
    </div>
</body>
<script>
    var teacher_id;
    var subject_id;
    var student_id;
    var status;
    $(function () {
        student_id = getQueryString("link");
        if (!$.isEmptyObject(student_id)) {
            setMSGStyle();
            setStuMsg();
        } else {
            setSchool(0);
            setGrade(0);
        }

    });
    function setSchool(id) {
        $('#cbtsc').combotree({
            url: 'AjaxHandler/SchoolHandler.ashx?type=getjson',
            required: true,
            method: 'get',
            valueField: 'id',
            textField: 'text'
        });
        $('#cbtsc').combotree("setValue", id);
    }
    function setGrade(id) {
        $('#cbtsg').combotree({
            url: 'AjaxHandler/GradeHandler.ashx?type=getjson',
            required: true,
            method: 'get',
            valueField: 'id',
            textField: 'text'
        });
        $('#cbtsg').combotree("setValue", id);
    }
    function addStu() {
        //学生基本信息
        var txtstuname = $("#txtstuname").val();
        var txtage = $("#txtage").val();
        var slsex = $("#slsex").val();
        var txtschool = $('#cbtsc').combotree("getValue");
        var slgrade = $('#cbtsg').combotree("getValue");
        var txtparent_name = $("#txtparent_name").val();
        var txtparent_phone = $("#txtparent_phone").val();
        var txtparent_dep = $("#txtparent_dep").val();
        var txtparent_address = $("#txtparent_address").val();
        var txtemail = $("#txtemail").val();
        //报名信息
        var reg = "";
        var cost = 0;
        try {
            if ($('#dg').datagrid("getChecked")) {
                var ac = $('#dg').datagrid("getChecked");
                if (ac.length > 0) {
                    for (var i = 0; i < ac.length; i++) {
                        reg = reg + ac[i].Course_id + ",";
                    }
                }
            }
            cost = $("#txtpay").val();
        } catch (e) { }
        $.post('AjaxHandler/StudentHandler.ashx',
            {
                'type': 'add',
                'name': txtstuname,
                'age': txtage,
                'sex': slsex,
                'school': txtschool,
                'grade': slgrade,
                'pname': txtparent_name,
                'pphone': txtparent_phone,
                'pdep': txtparent_dep,
                'paddress': txtparent_address,
                'pemail': txtemail,
                'regsub': reg,
                'regpay': cost
            },
            function (data, status) {

                if (status == 'success') {
                    checkLogin(data);
                    if (data == "success")
                        alert("添加学生并且报名成功。");
                    else if (data == "nopower") alert("没有登陆或没有权限。");
                    else alert(data);
                } else alert("添加失败。");
            });
    }
    function clearall() {
        $("#txtstuname").val('');
        $("#txtage").val('');
        $("#txtparent_name").val('');
        $("#txtparent_phone").val('');
        $("#txtparent_dep").val('');
        $("#txtparent_address").val('');
        $("#txtemail").val('');
        $("#txtage").val('');
    }
    function courseSlide() {
        $("#addsignup").slideToggle();
        loadTree();
        loadteacher();
        getVal(loadtable);
    }
    function setMSGStyle() {
        $('#addsignup').css('display', 'inherit');
        $('#acourse').css('display', 'none');
        $('#divbtn').css('display', 'none');
        $('.box_bottom').css('display', 'none');
        $('#divexit').css('display', 'inherit');
        loadhastable();
    }
    function EditStu(){
        if (confirm('是否确定修改学生信息？')) {
            //学生基本信息
            var txtstuname = $("#txtstuname").val();
            var txtage = $("#txtage").val();
            var slsex = $("#slsex").val();
            var txtschool = $('#cbtsc').combotree("getValue");
            var slgrade = $('#cbtsg').combotree("getValue");
            var txtparent_name = $("#txtparent_name").val();
            var txtparent_phone = $("#txtparent_phone").val();
            var txtparent_dep = $("#txtparent_dep").val();
            var txtparent_address = $("#txtparent_address").val();
            var txtemail = $("#txtemail").val();
            $.post('AjaxHandler/StudentHandler.ashx',
            {
                'type': 'edit',
                'stu_id':student_id,
                'name': txtstuname,
                'age': txtage,
                'sex': slsex,
                'school': txtschool,
                'grade': slgrade,
                'pname': txtparent_name,
                'pphone': txtparent_phone,
                'pdep': txtparent_dep,
                'paddress': txtparent_address,
                'pemail': txtemail
            },
            function (data, status) {

                if (status == 'success') {
                    checkLogin(data);
                    if (data == "success")
                        alert("修改成功。");
                    else if (data == "nopower") alert("没有登陆或没有权限。");
                    else alert(data);
                } else alert("修改失败。");
            });
        }else return;
    }
    function setStuMsg() {
        $.post('AjaxHandler/StudentHandler.ashx',
        {
            'type': 'getdetail',
            'stu_id': student_id
        },
        function (data, status) {
            if (status == "success") {
                try {
                    var json = jQuery.parseJSON(data);
                    $("#txtstuname").val(json.stu_name);
                    $("#labStuid").text(json.stu_id);
                    $("#txtage").val(json.stu_age);
                    setSchool(json.stu_school_id);
                    setGrade(json.stu_grade);
                    $("#txtparent_name").val(json.parent_name);
                    $("#txtparent_phone").val(json.parent_mobile);
                    $("#txtparent_dep").val(json.parent_dep);
                    $("#txtparent_address").val(json.address);
                    $("#txtemail").val(json.stu_grade);
                    $('#slsex').val(json.stu_sex);
                } catch (e) {
                    alert("加载学生信息出错。");
                    history.go(-1);
                }
            } else {
                alert("获取学生信息出错。");
                history.go(-1);
            }
        });
    }
    function loadTree() {
        $('#cbt').combotree({
            url: 'AjaxHandler/SubjectHandler.ashx?type=gettable',
            required: true,
            method: 'get',
            valueField: 'id',
            textField: 'text',
            onChange: function (newValue, oldValue) {
                getVal(loadtable);
            }
        });
        $('#cbt').combotree("setValue", 0);
    }
    function loadteacher() {
        $('#cbtTe').combotree({
            url: 'AjaxHandler/TeacherHandler.ashx?type=getjson',
            required: true,
            method: 'get',
            valueField: 'id',
            textField: 'text',
            onChange: function (newValue, oldValue) {
                getVal(loadtable);
            }
        });
        $('#cbtTe').combotree("setValue", 0);
    }
    function getVal(callback) {
        teacher_id = $('#cbtTe').combotree("getValue");
        subject_id = $('#cbt').combotree("getValue");
        status = $('#sestatus').val();
        callback();
    }
    function loadtable() {
        $('#dg').datagrid({
            title: '课程列表显示',
            iconCls: 'icon-edit',
            singleSelect: false,
            idField: 'Course_id',
            url: 'AjaxHandler/CourseHandler.ashx',
            pagination: true,
            pageSize: 10,
            queryParams: {
                type: 'gettable',
                teacher_id: teacher_id,
                subject_id: subject_id,
                status: status,
                stu_id: student_id
            },
            width: 960,
            columns: [[
                { field: 'Sc_stu_id', title: '全选', width: 100, align: 'center', checkbox: true },
                { field: 'Course_id', title: '课程ID', width: 60 },
                { field: 'Course_title', title: '科目名称', width: 200, align: 'center', editor: 'text' },
                { field: 'Subject_title', title: '所属科目', width: 100, align: 'center' },
                { field: 'Teacher_realname', title: '任课老师', width: 100, align: 'center' },
                { field: 'Course_cost', title: '收费(元)', width: 70, align: 'center' },
                { field: 'Course_info', title: '时间说明', width: 200, align: 'center' }
            ]],
            onLoadSuccess: function (row) {//当表格成功加载时执行               
                var rowData = row.rows;
                $.each(rowData, function (idx, val) {//遍历JSON
                    if (!$.isEmptyObject(val.Sc_stu_id)) {
                        $("#dg").datagrid("selectRow", idx); //如果数据行为已选中则选中改行
                    }
                });
            },
            onCheck: function (index, row) {
                setCost(index, row);
            },
            onUncheck: function (index, row) {
                setCost(index, row);
            },
            onCheckAll: function (index, row) {
                setCost(index, row);
            },
            onUncheckAll: function (index, row) {
                setCost(index, row);
            }
        });
    }
    function loadhastable() {
        $('#dg').datagrid({
            title: '已选课程列表显示',
            iconCls: 'icon-edit',
            singleSelect: false,
            idField: 'Course_id',
            url: 'AjaxHandler/StudentVsCourseHandler.ashx',
            pagination: true,
            pageSize: 10,
            queryParams: {
                type: 'gettable',
                stu_id: student_id
            },
            width: 960,
            columns: [[
                { field: 'Course_id', title: '课程ID', width: 50 },
                { field: 'Course_title', title: '科目名称', width: 150, align: 'center', editor: 'text' },
                { field: 'Subject_title', title: '所属科目', width: 100, align: 'center' },
                { field: 'Teacher_realname', title: '任课老师', width: 100, align: 'center' },
                { field: 'Sc_pay', title: '交费(元)', width: 70, align: 'center' },
                { field: 'Course_info', title: '时间说明', width: 300, align: 'center' }
            ]]
        });
    }
    function getRowIndex(target) {
        var tr = $(target).closest('tr.datagrid-row');
        return parseInt(tr.attr('datagrid-row-index'));
    }
    function setCost(index, row) {
        var ac = $('#dg').datagrid("getChecked");
        var mo = 0;
        for (var i = 0; i < ac.length; i++) {
            mo = parseFloat(ac[i].Course_cost) + mo;
        }
        $("#txtpay").val(mo);
    }
</script>
</html>
