<!doctype html>
<html lang="zh-CN">
<head>
    <base target="right" />
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/easyui.css" />
    <script type="text/javascript" src="Scripts/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="Scripts/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="Scripts/typecheck.js"></script>
    <title>后台首页</title>
    <style>
        #contain
        {
            width: 960px;
            margin-left: 15px;
            margin-righ: 15px;
        }
    </style>
    <script>
        $(function () {
            loadTree();
            loadtable();
        });
        function loadTree() {
            $('#cbt').combotree({
                url: 'AjaxHandler/RoleHandler.ashx',
                required: true,
                method: 'post',
                valueField: 'id',
                textField: 'text',
                onChange: function (newValue, oldValue) {

                }
            });
        }
        function reloadTree() {
            $('#cbt').combotree('reload', 'AjaxHandler/RoleHandler.ashx');
        }
        function checkAll(obj) {
            var isCheck = obj.checked;
            var boxlist = $("#alist_table").find("input", "[type='checkbox']");
            for (var i = 0; i < boxlist.length; i++) {
                boxlist[i].checked = isCheck;
            }
        }
        function AddRole() {
            var role_name = $("#txtrolename").val();

            if (role_name == "")
                alert("输入角色名称");
            else {
                if (!isValidString(sub_title)) {
                    var parent_title = $(".combo-value").val();
                    $.post("AjaxHandler/RoleHandler.ashx",
                    { 'type': 'add',
                        'parent_title': parent_title,
                        'role_name': role_name
                    },
                    function (data, status) {
                        if (status == "success") {
                            if (data == "success") {
                                alert("添加成功。");
                                loadtable();
                                reloadTree();
                            }
                            else if (data == "exists") alert("角色重复。");
                            else {
                                alert("添加失败。")
                            }
                        } else {
                            alert("添加失败。");
                        }
                    });
                } else {
                    alert('角色名称包含危险字符。');
                }
            }
        }
    </script>
</head>
<body>
    <div id="contain">
        <div id="search_bar" class="mt10">
            <div class="box">
                <div class="box_border">
                    <div class="box_top">
                        <b class="pl15">添加角色</b></div>
                    <div class="box_center pt10 pb10">
                        &nbsp;&nbsp;上级角色：<span>
                            <div class="select_border">
                                <div class="select_containers ">
                                    <input id="cbt" style="width: 200px;" />
                                </div>
                            </div>
                            <span style="color: Red">(不选择上级角色则新增为一级角色)</span> </span>&nbsp;&nbsp; 角色名称：<input
                                type="text" id="txtrolename" name="name" class="input-text lh30" size="30" />
                        &nbsp;&nbsp;
                        <input type="button" name="button" class="btn btn82 btn_add" onclick="AddRole();"
                            value="新增" />
                    </div>
                </div>
            </div>
        </div>
        <div id="table" class="mt10">
            <div class="box span10 oh">
                <table id="dg" title="角色列表显示">
                </table>
            </div>
        </div>
    </div>
</body>
<script>
    function pagerFilter(data) {
        if (typeof data.length == 'number' && typeof data.splice == 'function') {	// is array
            data = {
                total: data.length,
                rows: data
            }
        }
        var dg = $(this);
        var opts = dg.datagrid('options');
        var pager = dg.datagrid('getPager');
        pager.pagination({
            onSelectPage: function (pageNum, pageSize) {
                opts.pageNumber = pageNum;
                opts.pageSize = pageSize;
                pager.pagination('refresh', {
                    pageNumber: pageNum,
                    pageSize: pageSize
                });
                dg.datagrid('loadData', data);
            }
        });
        if (!data.originalRows) {
            data.originalRows = (data.rows);
        }
        var start = (opts.pageNumber - 1) * parseInt(opts.pageSize);
        var end = start + parseInt(opts.pageSize);
        data.rows = (data.originalRows.slice(start, end));
        return data;
    }
    var pagesize = 10;
    var pagenumber = 1;
    function loadtable() {
        $('#dg').datagrid({ loadFilter: pagerFilter }).datagrid({
            title: '角色列表显示',
            iconCls: 'icon-edit',
            singleSelect: false,
            idField: 'Role_id',
            url: 'AjaxHandler/RoleHandler.ashx',
            method: 'post',
            pagination: true,
            pageSize: pagesize,
            pageNumber: pagenumber,
            queryParams: {
                type: "getlist"
            },
            columns: [[
                { field: 'Role_id', title: '角色ID', width: 60 },
                { field: 'Role_name', title: '角色名称', width: 200, align: 'center', editor: 'text' },
                { field: 'parent', title: '上级角色', width: 200, align: 'center',
                    editor: {
                        type: 'combotree',
                        options: {
                            method: 'post',
                            valueField: 'id',
                            textField: 'text',
                            url: 'AjaxHandler/RoleHandler.ashx',
                            queryParams: {
                                type: "getlist"
                            },
                            required: true
                        }
                    }
                },
                { field: 'action', title: '操作', width: 100, align: 'center',
                    formatter: function (value, row, index) {
                        if (row.editing) {
                            var s = '<a href="#" onclick="saverow(this)">保存</a> ';
                            var c = '<a href="#" onclick="cancelrow(this)">取消</a>';
                            return s + c;
                        } else {
                            var e = '<a href="#" onclick="editrow(this)">编辑</a> ';
                            var d = '<a href="#" onclick="deleterow(this)">删除</a>';
                            return e + d;
                        }
                    }
                }
            ]],
            onBeforeEdit: function (index, row) {
                row.editing = true;
                updateActions(index);
            },
            onAfterEdit: function (index, row) {
                editSave(row);
                row.editing = false;
                updateActions(index);
            },
            onCancelEdit: function (index, row) {
                row.editing = false;
                updateActions(index);
            }
        });
        //分页事件
        var pg = $('#dg').datagrid("getPager");
        $(pg).pagination({
            //选择每页显示列表数量
            onChangePageSize: function (pageSize) {
                pagesize = pageSize;
                loadtable();
            },
            //刷新列表
            onRefresh: function (pageNumber, pageSize) {
                pagesize = pageSize;
                pagenumber = pageNumber;
                loadtable();
            },
            //直接点击页码
            onSelectPage: function (pageNumber, pageSize) {
                pagesize = pageSize;
                pagenumber = pageNumber;
                loadtable();
            }
        });
    }
    function updateActions(index) {
        $('#dg').datagrid('updateRow', {
            index: index,
            row: {}
        });
    }
    function getRowIndex(target) {
        var tr = $(target).closest('tr.datagrid-row');
        return parseInt(tr.attr('datagrid-row-index'));
    }
    //编辑行
    function editrow(target) {
        $('#dg').datagrid('beginEdit', getRowIndex(target));
    }
    function deleterow(target) {
        $.messager.confirm('警告', '确实删除?', function (r) {
            if (r) {
                var id = $('#dg').datagrid('getSelected').Role_id;
                $.post("AjaxHandler/RoleHandler.ashx",
                { "type": "delete",
                    "id": id
                },
                function (data, status) {
                    if (status == "success") {
                        if (data == "success") {
                            alert("删除成功");
                            //loadtable();
                            reloadTree();
                            $('#dg').datagrid('deleteRow', getRowIndex(target));
                        } else
                            alert("共删失败");
                    } else alert("删除失败。");
                });
            }
        });
    }
    function saverow(target) {
        $('#dg').datagrid('endEdit', getRowIndex(target));
    }
    function cancelrow(target) {
        $('#dg').datagrid('cancelEdit', getRowIndex(target));
    }

    function editSave(row) {
        var id = row.Role_id;
        var pid = row.parent;
        if (id == pid) {
            alert("不能把自已作为上级角色。");
            return;
        }
        $.post("AjaxHandler/RoleHandler.ashx",
                { "type": "edit",
                    "id": row.Role_id,
                    "parent_title": row.parent,
                    "sub_title": row.Role_name
                },
                function (data, status) {
                    if (status == "success") {
                        if (data == "success")
                            alert("编辑成功");
                        else if (data == "exists")
                            alert("所改名称已存在。");
                        else if (data == "nosubject")
                            alert("所选角色已被删除，请刷新列表。");
                        else
                            alert("编辑失败");
                    } else alert("编辑失败。");
                });
        reloadTree();
    }
</script>
</html>
