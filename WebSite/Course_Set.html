<!doctype html>
<html lang="zh-CN">
<head>
    <base target="right" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="css/main.css"/>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/easyui.css" />
    <script type="text/javascript" src="Scripts/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="Scripts/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="Scripts/typecheck.js"></script>
    <title>后台首页</title>
    <style>
    #contain{width:960px;margin-left:15px;margin-right:15px;}
    #addtb td{height:40px;}
    .input-text{padding:0px 5px 0px 5px}
    .combo{border:none;}
    .select_border2{padding:0 0 0 0;height: 30px;  display: inline-block;  border: 1px solid #bac7d2;background: #fff;}
    .input-text2{  padding: 0px 5px 0px 5px;}
    </style>
    <script>
        function checkAll(obj) {
            var isCheck = obj.checked;
            var boxlist = $("#alist_table").find("input", "[type='checkbox']");
            for (var i = 0; i < boxlist.length; i++) {
                boxlist[i].checked = isCheck;
            }
        }
        function AddCourse() {
            var sub_id = $('#cbt').combotree("getValue");
            var teacher = $('#cbtTe').combotree("getValue");
            var info = $('#txtinfo').val();
            var cost = $('#txtcost').val();
            if (sub_id == "" || sub_id == "0")
                alert("请选择科目");
            else {
                var course = $("#txtcourse").val();
                if (course == "") {
                    alert("请选择课程名称。");
                    return;
                }
                if (!isValidString(course)) {
                    $.post("AjaxHandler/CourseHandler.ashx",
                    { 'type': 'add',
                        'sub_id': sub_id,
                        'title': course,
                        'teacher': teacher,
                        'info': info,
                        'cost': cost
                    },
                    function (data, status) {
                        if (status == "success") {
                            if (data == "success") {
                                alert("添加成功。");
                                //loadTree();
                                $('#dg').datagrid("reload");
                            } else if (data == "hasname") alert("科目重复。");
                            else {
                                alert(data)
                            }
                        } else {
                            alert("添加失败。");
                        }
                    });
                } else {
                alert('课程名称包含危险字符。');
                }
            }
        }
    </script>
</head>
<body>
    <div id="contain">
    <div id="search_bar" class="mt10">
       <div class="box">
          <div class="box_border">
            <div class="box_top"><b class="pl15">添加课程</b></div>
            <div class="box_center pt10 pb10">
            <table id="addtb" cellpadding="0" cellspacing="0" border="0">
            <tr>
            <td>&nbsp;&nbsp;科目筛选：</td>
            <td><span>
                      <div class="select_border"> 
                        <div class="select_containers "> 
                       <input id="cbt" style="width:200px;" />
                        </div> 
                      </div> 
                    </span></td>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;课程名称：</td>
            <td><input type="text" id="txtcourse" name="name" class="input-text lh30" style="width:200px;" /></td>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;报名价格： </td>
            <td><input type="text" id="txtcost" name="name" class="input-text lh30" style="width:200px;" /></td>
            </tr>
            <tr>
            <td>&nbsp;&nbsp;选择老师：</td>
            <td><span>
                      <div class="select_border"> 
                        <div class="select_containers "> 

                        <input id="cbtTe" style="width:200px;" />
                        </div> 
                      </div> 
                    </span></td>
            <td></td>
            <td></td>
            <td colspan="2">
            </td>
            </tr>
            <tr>
            <td>
            &nbsp;&nbsp;课程介绍：
            </td>
            <td colspan="3">
            <textarea id="txtinfo" rows="10" name="name" class="input-text2" style="width:480px;" ></textarea>
            </td>
            <td colspan="2">&nbsp;&nbsp;
            <input type="button" name="button" onclick="AddCourse();" class="btn btn82 btn_add" value="新增"/>
            </td>
            </tr>
            </table>
            </div>
          </div>
        </div>
    </div>
    <div id="table" class="mt10">
        <div class="box span10 oh">
        <div class="box_bottom pb5 pt5 pr10" style="border:1px solid #dadada;">
              <div class="search_bar_btn">
        &nbsp;&nbsp;
                    课程状态：<span>
                      <div class="select_border2"> 
                        <div class="select_containers "> 
                        <select name="" id="sestatus" class="select"> 
                        <option value="0">全部</option> 
                        <option value="1">已结束</option> 
                        <option value="2">进行中</option> 
                        <option value="3">未开始</option> 
                        </select> 
                        </div> 
                      </div> 
                    </span>
                     &nbsp;&nbsp; <input type="button" name="button" class="btn btn82 btn_del" value="删除"/>
        </div></div>
        <br />
             <table id="dg" title="课程列表显示" />
        
        </div>
     </div>
     </div>
</body>
<script>
    var teacher_id;
    var subject_id;
    var status;
    loadTree();
    loadteacher();
    $(function () {
        InitDataTxt();
        getVal(loadtable);
    });
    function loadTree() {
        $('#cbt').combotree({
            url: 'AjaxHandler/SubjectHandler.ashx?type=gettable',
            required: true,
            method: 'get',
            valueField: 'id',
            textField: 'text',
            onChange: function (newValue, oldValue) {
                getVal(loadtable);
            }
        });
        $('#cbt').combotree("setValue", 0);
    }
    function loadteacher() {
        $('#cbtTe').combotree({
            url: 'AjaxHandler/TeacherHandler.ashx?type=getjson',
            required: true,
            method: 'get',
            valueField: 'id',
            textField: 'text',
            onChange: function (newValue, oldValue) {
                getVal(loadtable);
            }
        });
        $('#cbtTe').combotree("setValue", 0);
    }
    function InitDataTxt() {
        $('#txtdate').timespinner({
            min: '00:00',
            required: true,
            showSeconds: true
        });
        $('#txtdate').timespinner("setValue", "00:00:00");
    }
    function getVal(callback) {
        teacher_id = $('#cbtTe').combotree("getValue");
        subject_id = $('#cbt').combotree("getValue");
        status = $('#sestatus').val();
        callback();
    }
    function pagerFilter(data) {
        if (typeof data.length == 'number' && typeof data.splice == 'function') {	// is array
            data = {
                total: data.length,
                rows: data
            }
        }
        var dg = $(this);
        var opts = dg.datagrid('options');
        var pager = dg.datagrid('getPager');
        pager.pagination({
            onSelectPage: function (pageNum, pageSize) {
                opts.pageNumber = pageNum;
                opts.pageSize = pageSize;
                pager.pagination('refresh', {
                    pageNumber: pageNum,
                    pageSize: pageSize
                });
                dg.datagrid('loadData', data);
            }
        });
        if (!data.originalRows) {
            data.originalRows = (data.rows);
        }
        var start = (opts.pageNumber - 1) * parseInt(opts.pageSize);
        var end = start + parseInt(opts.pageSize);
        data.rows = (data.originalRows.slice(start, end));
        return data;
    }
    var pagesize = 10;
    var pagenumber = 1;
    function loadtable() {
        $('#dg').datagrid({ loadFilter: pagerFilter }).datagrid({
            title: '课程列表显示',
            iconCls: 'icon-edit',
            singleSelect: false,
            idField: 'Course_id',
            url: 'AjaxHandler/CourseHandler.ashx',
            pagination: true,
            pageSize: pagesize,
            pageNumber: pagenumber,
            queryParams: {
                type: 'gettable',
                teacher_id: teacher_id,
                subject_id: subject_id,
                status: status
            },
            columns: [[
                { field: 'cb', title: '全选', width: 100, align: 'center', checkbox: true },
                { field: 'Course_id', title: '课程ID', width: 60 },
                { field: 'Course_title', title: '科目名称', width: 200, align: 'center', editor: 'text' },
                { field: 'Subject_title', title: '所属科目', width: 100, align: 'center' },
                { field: 'Teacher_realname', title: '任课老师', width: 100, align: 'center' },
                { field: 'Course_cost', title: '收费(元)', width: 70, align: 'center' },
                { field: 'Course_info', title: '时间说明', width: 200, align: 'center' },
                { field: 'action', title: '操作', width: 100, align: 'center',
                    formatter: function (value, row, index) {
                            var e = '<a href="#" onclick="editrow(this)">编辑</a> ';
                            var d = '<a href="#" onclick="deleterow(this,' + row.Course_id + ')">删除</a>';
                            return e + d;
                    }
                }
            ]],
            onBeforeEdit: function (index, row) {
                row.editing = true;
                updateActions(index);
            },
            onAfterEdit: function (index, row) {
                editSave(row);
                row.editing = false;
                updateActions(index);
            },
            onCancelEdit: function (index, row) {
                row.editing = false;
                updateActions(index);
            }
        });
        //分页事件
        var pg = $('#dg').datagrid("getPager");
        $(pg).pagination({
            //选择每页显示列表数量
            onChangePageSize: function (pageSize) {
                pagesize = pageSize;
                loadtable();
            },
            //刷新列表
            onRefresh: function (pageNumber, pageSize) {
                pagesize = pageSize;
                pagenumber = pageNumber;
                loadtable();
            },
            //直接点击页码
            onSelectPage: function (pageNumber, pageSize) {
                pagesize = pageSize;
                pagenumber = pageNumber;
                loadtable();
            }
        });
    }
    function updateActions(index) {
        $('#dg').datagrid('updateRow', {
            index: index,
            row: {}
        });
    }
    function getRowIndex(target) {
        var tr = $(target).closest('tr.datagrid-row');
        return parseInt(tr.attr('datagrid-row-index'));
    }
    //编辑行
    function editrow(target) {
        $('#dg').datagrid('beginEdit', getRowIndex(target));
    }
    function deleterow(target, id) {
        $.messager.confirm('警告', '确实删除?', function (r) {
            if (r) {
                $.post("AjaxHandler/CourseHandler.ashx",
                { "type": "delete",
                    "id": id
                },
                function (data, status) {
                    if (status == "success") {
                        if (data == "success") {
                            alert("删除成功");
                            $('#dg').datagrid('deleteRow', getRowIndex(target));
                        } else
                            alert("删除失败");
                    } else alert("删除失败。");
                });
            }
        });
    }
    function saverow(target) {
        $('#dg').datagrid('endEdit', getRowIndex(target));
    }
    function cancelrow(target) {
        $('#dg').datagrid('cancelEdit', getRowIndex(target));
    }

    function Delete() {
        $.messager.confirm('警告', '确实删除?', function (r) {
            if (r) {
                var debox = $('#dg').datagrid('getChecked');
                var len = debox.length;
                if (len == 0) {
                    alert("没有选择任何行。");
                    return;
                }
                var ids = "";
                for (var i = 0; i < len; i++) {
                    ids += debox[i].Subject_id + ',';
                }
                $.post("AjaxHandler/CourseHandler.ashx",
                { "type": "deletelist",
                    "ids": ids
                },
                function (data, status) {
                    if (status == "success") {
                        alert("共删除课程" + data + "");
                        loadtable();
                    } else alert("删除失败。");
                });
            }
        });
    }
    function editSave(row) {
        var id = row.Subject_id;
        var pid = row.parent;
        if (id == pid) {
            alert("不能把自已作为上级科目。");
            return;
        }
        $.post("AjaxHandler/CourseHandler.ashx",
                { "type": "edit",
                    "id": row.Subject_id,
                    "parent_title": row.parent,
                    "sub_title": row.Subject_title
                },
                function (data, status) {
                    if (status == "success") {
                        if (data == "success")
                            alert("编辑成功");
                        else if (data == "exists")
                            alert("所改名称已存在。");
                        else if (data == "nosubject")
                            alert("所选科目已被删除，请刷新列表。");
                        else
                            alert("编辑失败");
                    } else alert("编辑失败。");
                });
    }
</script>
</html>
