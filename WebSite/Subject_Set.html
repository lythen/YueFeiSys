<!doctype html>
<html lang="zh-CN">
<head>
    <base target="right" />
    <META HTTP-EQUIV="pragma" CONTENT="no-cache"> 
<META HTTP-EQUIV="Cache-Control" CONTENT="no-store, must-revalidate"> 
<META HTTP-EQUIV="expires" CONTENT="Wed, 26 Feb 1997 08:21:57 GMT"> 
<META HTTP-EQUIV="expires" CONTENT="0"> 
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/easyui.css" />
    <script type="text/javascript" src="Scripts/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="Scripts/jquery.easyui.min.js"></script>
    <title>后台首页</title>
    <style>
    #contain{width:960px;margin-left:15px;margin-righ:15px;}
    </style>
    <script>
        $(function () {
            loadTree();
            loadtable();
        });
        function loadTree() {
            $('#cbt').combotree({
                url: 'AjaxHandler/SubjectComboTreeHandler.ashx',
                required: true,
                method: 'get',
                valueField: 'id',
                textField: 'text',
                onChange: function (newValue, oldValue) {

                }
            });
        }
        function checkAll(obj) {
            var isCheck = obj.checked;
            var boxlist = $("#alist_table").find("input", "[type='checkbox']");
            for (var i = 0; i < boxlist.length; i++) {
                boxlist[i].checked = isCheck;
            }
        }
        function AddSubject() {
            var sub_title = $(".txtsubtitle-value").val();
            
            if (sub_title == "")
                alert("输入科目名称");
            else {
                if (!isValidString(sub_title)) {
                    var parent_id = $(".combo-value").val();
                    $.post("AjaxHandler/SubjectHandler.ashx",
                    { 'type': 'add',
                        'parent_id': parent_id,
                        'sub_title': sub_title
                    },
                    function (data, status) {
                        if (status == "success") {
                            if (data == "success") {
                                alert("添加成功。");
                                loadTree();
                            }
                            else if (data == "hasname") alert("科目重复。");
                            else {
                                alert("添加失败。")
                            }
                        } else {
                            alert("添加失败。");
                        }
                    });
                } else {
                    alert('科目名称包含危险字符。');
                }
            }
        }
    </script>
</head>
<body>
     <div id="contain">
    <div id="search_bar" class="mt10">
       <div class="box">
          <div class="box_border">
            <div class="box_top"><b class="pl15">添加科目</b></div>
            <div class="box_center pt10 pb10">
              &nbsp;&nbsp;上级科目：<span>
                      <div class="select_border"> 
                        <div class="select_containers "> 
                        <input id="cbt" style="width:200px;" />
                        </div> 
                      </div> <span style="color:Red">(不选择上级科目则新增为一级科目)</span>
                    </span>
                    &nbsp;&nbsp;
                    科目名称：<input type="text" id="txtsubtitle" name="name" class="input-text lh30" size="40" />
                    &nbsp;&nbsp;
                    <input type="button" name="button" class="btn btn82 btn_add" onclick="AddSubject();" value="新增" /> 
            </div>
          </div>
        </div>
    </div>
    <div id="table" class="mt10">
        <div class="box span10 oh">
        <div class="box_bottom pb5 pt5 pr10" style="border-top:1px solid #dadada;">
              <div class="search_bar_btn">
        <input type="button" name="button" class="btn btn82 btn_del" value="删除"/>
        </div></div>
              <table width="100%" border="0" cellpadding="0" cellspacing="0" id="alist_table" class="list_table" style="display:none;">
                <tr>
                   <th width="30"><input type="checkbox" onclick="checkAll(this);" name="button" value="全选"/>全选 </th>
                   <th width="100">科目ID</th>
                   <th width="100">科目名称</th>
                   <th width="100">科目级别</th>
                   <th width="100">上级科目</th>
                   <th width="100">操作</th>
                    </tr>
                <tr class="tr">
                   <td class="td_center"><input id="checkbox1" class="cbx" type="checkbox" /></td>
                   <td>aad</td>
                   <td>aad</td>
                   <td>aad</td>
                <td>aad</td>
                <td align="center"><a href="">详细</a></td>
                 </tr>
                 <tr class="tr"> 
                   <td class="td_center"><input id="checkbox2" class="cbx" type="checkbox"/></td>
                   <td>aad</td>
                   <td>aad</td>
                   <td>aad</td>
                <td>aad</td>
                <td align="center"><a href="">详细</a></td>
                 </tr>
                 <tr class="tr">
                    <td class="td_center"><input id="checkbox3" class="cbx" type="checkbox"/></td>
                   <td>aad</td>
                   <td>aad</td>
                   <td>aad</td>
                <td>aad</td>
                 </tr>
                 <tr class="tr">
                    <td class="td_center"><input id="checkbox4" class="cbx" type="checkbox"/></td>
                   <td>aad</td>
                   <td>aad</td>
                   <td>aad</td>
                <td>aad</td>
                 </tr>
                 <tr class="tr">
                    <td class="td_center"><input type="checkbox"></td>
                   <td>aad</td>
                   <td>aad</td>
                   <td>aad</td>
                <td>aad</td>
                 </tr>
                 <tr class="tr">
                   <td class="td_center"><input type="checkbox"></td>
                   <td>aad</td>
                   <td>aad</td>
                   <td>aad</td>
                <td>aad</td>
                 </tr>
                 <tr class="tr">
                   <td class="td_center"><input type="checkbox"></td>
                   <td>aad</td>
                   <td>aad</td>
                   <td>aad</td>
                <td>aad</td>
                 </tr>
                 <tr class="tr">
                   <td class="td_center"><input type="checkbox"></td>
                   <td>aad</td>
                   <td>aad</td>
                   <td>aad</td>
                <td>aad</td>
                 </tr>
                 <tr class="tr">
                   <td class="td_center"><input type="checkbox"></td>
                   <td>aad</td>
                   <td>aad</td>
                   <td>aad</td>
                <td>aad</td>
                 </tr>
              
              </table>
              <div class="page mt10">
                <div class="pagination">
                  <ul>
                      <li class="first-child"><a href="#">首页</a></li>
                      <li class="disabled"><span>上一页</span></li>
                      <li class="active"><span>1</span></li>
                      <li><a href="#">2</a></li>
                      <li><a href="#">下一页</a></li>
                      <li class="last-child"><a href="#">末页</a></li>
                  </ul>
                </div>

              </div>
        
        <table id="dg" title="科目列表显示">
        </table>
        </div>
     </div>
     </div>
</body>
<script>
    function pagerFilter(data) {
        if (typeof data.length == 'number' && typeof data.splice == 'function') {	// is array
            data = {
                total: data.length,
                rows: data
            }
        }
        var dg = $(this);
        var opts = dg.datagrid('options');
        var pager = dg.datagrid('getPager');
        pager.pagination({
            onSelectPage: function (pageNum, pageSize) {
                opts.pageNumber = pageNum;
                opts.pageSize = pageSize;
                pager.pagination('refresh', {
                    pageNumber: pageNum,
                    pageSize: pageSize
                });
                dg.datagrid('loadData', data);
            }
        });
        if (!data.originalRows) {
            data.originalRows = (data.rows);
        }
        var start = (opts.pageNumber - 1) * parseInt(opts.pageSize);
        var end = start + parseInt(opts.pageSize);
        data.rows = (data.originalRows.slice(start, end));
        return data;
    }
    function loadtable(){
    $('#dg').datagrid({ loadFilter: pagerFilter }).datagrid({
            title:'科目列表显示',
            iconCls:'icon-edit',
            singleSelect:false,
            idField:'sub_id',
            url: 'AjaxHandler/SubjectHandler.ashx',
            pagination:true,
			pageSize:10,
            columns:[[
                {field:'cb',title:'全选',width:100,align:'center',checkbox:true},
                {field:'sub_id',title:'科目ID',width:60},
                { field: 'sub_title', title: '科目名称', width: 200, align: 'center',editor:'text'},
                {field:'sub_parent',title:'上级科目',width:200,align:'center',
                    editor:{
                            type:'combotree',
                            options:{
                                method: 'get',
                                valueField:'id',
                                textField:'text',
                                url:'AjaxHandler/SubjectComboTreeHandler.ashx',
                                required:true
                            }
                        }
                },
                {field:'action',title:'操作',width:100,align:'center',
                    formatter:function(value,row,index){
                        if (row.editing){
                            var s = '<a href="#" onclick="saverow(this)">保存</a> ';
                            var c = '<a href="#" onclick="cancelrow(this)">取消</a>';
                            return s+c;
                        } else {
                            var e = '<a href="#" onclick="editrow(this)">编辑</a> ';
                            var d = '<a href="#" onclick="deleterow(this)">删除</a>';
                            return e+d;
                        }
                    }
                }
            ]],
            onBeforeEdit:function(index,row){
                row.editing = true;
                updateActions(index);
            },
            onAfterEdit:function(index,row){
                row.editing = false;
                updateActions(index);
            },
            onCancelEdit:function(index,row){
                row.editing = false;
                updateActions(index);
            }
        });
}
function updateActions(index){
    $('#dg').datagrid('updateRow', {
        index: index,
        row:{}
    });
}
function getRowIndex(target){
    var tr = $(target).closest('tr.datagrid-row');
    return parseInt(tr.attr('datagrid-row-index'));
}
function editrow(target) {
    alert(getRowIndex(target));
    var k = $('#dg').datagrid('selectRow', getRowIndex(target));
    $('#dg').datagrid('beginEdit', getRowIndex(target));
}
function deleterow(target){
    $.messager.confirm('Confirm','确实删除?',function(r){
        if (r){
            $('#dg').datagrid('deleteRow', getRowIndex(target));
        }
    });
}
function saverow(target){
    $('#dg').datagrid('endEdit', getRowIndex(target));
}
function cancelrow(target){
    $('#dg').datagrid('cancelEdit', getRowIndex(target));
}
</script>
</html>
